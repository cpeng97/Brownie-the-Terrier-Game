<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brownie's Petting Party</title>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.min.js"></script>
    <style>
        body { margin: 0; background-color: #2c1e1a; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; font-family: 'VT323', monospace; }
        canvas { border: 4px solid #5d4037; }
    </style>
</head>
<body>
<script>
const config = {
    type: Phaser.AUTO,
    width: 800, height: 600,
    scene: { preload: preload, create: create, update: update }
};

const game = new Phaser.Game(config);
let brownie, hand, score = 0, bites = 0, level = 1, petsThisLevel = 0;
let gameState = 'ONBOARDING', uiPanel, statusBar, dogMood = 'calm';
let hearts = [], bandages = [], spots = [];

// maintains aspect ratio to prevent distortion
function setScaleFixed(item, targetWidth) {
    if(!item) return;
    let ratio = targetWidth / item.width;
    item.setScale(ratio);
}

function preload() {
    this.load.image('bg', 'assets/bg/bg_room.png');
    this.load.image('ol_barrel', 'assets/bg/bg_overlay_barrel.png');
    this.load.image('ol_bush', 'assets/bg/bg_overlay_bush.png');
    this.load.image('ol_grass', 'assets/bg/bg_overlay_dry_grass.png'); 
    this.load.image('ol_wood', 'assets/bg/bg_overlay_wood.png');
    this.load.image('ol_apple', 'assets/bg/bg_overlay_apple.png');
    this.load.image('b_idle1', 'assets/sprites/brownie_idle.png');
    this.load.image('b_idle2', 'assets/sprites/brownie_idle_2.png');
    this.load.image('b_idle3', 'assets/sprites/brownie_idle_3.png');
    this.load.image('b_excite1', 'assets/sprites/brownie_excited.png');
    this.load.image('b_excite2', 'assets/sprites/brownie_excited_2.png');
    this.load.image('b_happy', 'assets/sprites/brownie_happy.png');
    this.load.image('b_bite', 'assets/sprites/brownie_bite.png');
    this.load.image('h_neutral', 'assets/sprites/hand_neutral.png');
    this.load.image('h_pet', 'assets/sprites/hand_petting.png');
    this.load.image('h_hurt', 'assets/sprites/hand_hurt.png');
    this.load.image('ui_box', 'assets/ui/box.png'); 
    this.load.image('btn_start', 'assets/ui/ui_button_start.png');
    this.load.image('ui_heart', 'assets/ui/ui_heart_full.png');
    this.load.image('ui_bandage', 'assets/ui/ui_bandage.png');
}

function create() {
    const scene = this;
    this.add.image(400, 300, 'bg').setDisplaySize(800, 600);

    // Coordinate Spots (Adjust these if placement is still wrong)
    spots = [
        {x: 210, y: 500, img: 'ol_barrel', w: 160},
        {x: 430, y: 520, img: 'ol_grass', w: 240},
        {x: 720, y: 500, img: 'ol_bush', w: 180},
        {x: 435, y: 280, img: 'ol_apple', w: 120},
        {x: 750, y: 440, img: 'ol_wood', w: 160}
    ];

    spots.forEach(s => {
        let img = this.add.image(s.x, s.y, s.img).setDepth(20);
        setScaleFixed(img, s.w);
    });

    // Brownie setup
    this.anims.create({ key: 'idle', frames: [{key:'b_idle1'}, {key:'b_idle2'}, {key:'b_idle3'}], frameRate: 4, repeat: -1 });
    this.anims.create({ key: 'excite', frames: [{key:'b_excite1'}, {key:'b_excite2'}], frameRate: 10, repeat: -1 });
    
    brownie = this.add.sprite(400, 400, 'b_idle1').setInteractive().setDepth(15);
    setScaleFixed(brownie, 80);
    brownie.setVisible(false);

    // UI Status
    createStatusBar(this);

    // Hand setup
    hand = this.add.sprite(0, 0, 'h_neutral').setDepth(2000);
    setScaleFixed(hand, 100);
    this.input.setDefaultCursor('none');
    this.input.on('pointermove', (p) => { hand.setPosition(p.x, p.y); });

    showDialogue(this, "Meet Brownie!", "Instructions: Brownie will run between hiding spots. Pet her only while she's running! If she looks excited, watch out!", 'btn_start');

    brownie.on('pointerdown', () => handleInteraction(scene));

    // DEBUG MODE: Press D to see mouse coordinates to tell me where to move things
    this.input.keyboard.on('keydown-D', () => {
        console.log(`X: ${Math.round(scene.input.x)}, Y: ${Math.round(scene.input.y)}`);
    });
}

function createStatusBar(scene) {
    statusBar = scene.add.container(680, 70).setDepth(1000).setVisible(false);
    let barBg = scene.add.image(0, 0, 'ui_box'); barBg.setDisplaySize(220, 110);
    scene.add.text(-90, -35, "Life", { fontSize: '20px', color: '#5d4037', fontStyle: 'bold' });
    for(let i=0; i<3; i++) {
        let h = scene.add.image(-40 + (i*30), -30, 'ui_heart'); setScaleFixed(h, 22);
        hearts.push(h);
    }
    scene.add.text(-90, 5, "Bites", { fontSize: '20px', color: '#5d4037', fontStyle: 'bold' });
    for(let i=0; i<5; i++) {
        let b = scene.add.image(-35 + (i*28), 15, 'ui_bandage'); setScaleFixed(b, 24);
        b.setAlpha(0.2); bandages.push(b);
    }
    statusBar.add([barBg]);
}

function handleInteraction(scene) {
    if (gameState !== 'PLAY' || brownie.getData('isMoving') === false) return;

    if (dogMood === 'excited') {
        bites++;
        for(let i=0; i<bites; i++) { if(bandages[i]) bandages[i].setAlpha(1); }
        brownie.setTexture('b_bite');
        hand.setTexture('h_hurt');
        scene.cameras.main.shake(200, 0.02);
        if (bites >= 5) triggerGameOver(scene);
    } else {
        petsThisLevel++;
        score += 10;
        brownie.setTexture('b_happy');
        hand.setTexture('h_pet');
        if (petsThisLevel >= (level * 3)) {
            level++;
            if(level > 3) triggerWin(scene);
            else showDialogue(scene, "Level " + level, "Brownie is running faster!", 'btn_start');
        }
    }
    // Return to neutral hand after a delay
    scene.time.delayedCall(400, () => { if(gameState === 'PLAY') hand.setTexture('h_neutral'); });
}

function moveBrownie(scene) {
    if (gameState !== 'PLAY') return;

    // Pick two random spots
    let start = spots[Math.floor(Math.random() * spots.length)];
    let end = spots[Math.floor(Math.random() * spots.length)];
    while(start === end) { end = spots[Math.floor(Math.random() * spots.length)]; }

    brownie.setPosition(start.x, start.y).setVisible(true).setData('isMoving', true);
    
    // Decide mood for this run
    dogMood = (level > 1 && Math.random() > 0.6) ? 'excited' : 'calm';
    brownie.play(dogMood === 'excited' ? 'excite' : 'idle');

    // Move her
    scene.tweens.add({
        targets: brownie,
        x: end.x,
        y: end.y,
        duration: Math.max(800, 2500 - (level * 500)),
        onComplete: () => {
            brownie.setVisible(false).setData('isMoving', false);
            scene.time.delayedCall(Phaser.Math.Between(500, 1500), () => moveBrownie(scene));
        }
    });
}

function showDialogue(scene, title, body, btnImg) {
    gameState = 'PAUSE';
    uiPanel = scene.add.container(400, 300).setDepth(3000);
    let box = scene.add.image(0, 0, 'ui_box'); setScaleFixed(box, 600);
    let tTxt = scene.add.text(0, -60, title, { fontSize: '40px', color: '#5d4037', fontStyle: 'bold' }).setOrigin(0.5);
    let bTxt = scene.add.text(0, 20, body, { fontSize: '22px', color: '#5d4037', align: 'center', wordWrap: {width: 500} }).setOrigin(0.5);
    let btn = scene.add.image(0, 150, btnImg).setInteractive(); setScaleFixed(btn, 140);
    
    btn.on('pointerdown', () => {
        uiPanel.destroy();
        statusBar.setVisible(true);
        gameState = 'PLAY';
        moveBrownie(scene);
    });
    uiPanel.add([box, tTxt, bTxt, btn]);
}

function triggerGameOver(scene) {
    gameState = 'GAMEOVER';
    scene.add.rectangle(400,300,800,600,0x000000,0.7).setDepth(4000);
    scene.add.text(400,300, "THE TOY\nBrownie thinks your hand is a snack!", {fontSize:'40px', align:'center'}).setOrigin(0.5).setDepth(4001);
}

function triggerWin(scene) {
    gameState = 'WIN';
    // Dress up logic would go here
}

function update() {}
</script>
</body>
</html>
